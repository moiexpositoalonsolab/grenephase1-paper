#!/usr/bin/env Rscript

# This script uses the 'topr' R package to generate a region plot for the CYP707A1 genomic region.
# It visualizes association results (LFMM, Kendall's tau, Binomial Regression, and GEMMA)
# within this specific region along with gene annotations.

# --- Required Input Files (Generated by pre_topr.py) ---
# - tair_annotations_topr.tsv: Formatted gene annotations for topr.
# - lfmm_bio1_4topr_last_gen.csv: Processed LFMM results.
# - kendall_bio1_4topr_last_gen.csv: Processed Kendall's tau results.
# - binom_bio1_4topr_last_gen.csv: Processed Binomial Regression results.
# - gemma231_bio1_4topr.csv: Processed GEMMA 231 genomes results.

# --- Output Files ---
# - regionplot_lfmm_kendall_cyt.pdf: PDF file containing the generated region plot.

# Set library path to ensure topr package is found
.libPaths("/home/tbellagio/miniforge3/envs/r-environment/lib/R/library")

# Load the topr library
library(topr)

# Load the arabidopsis build data for topr
arabidopsis <- read.delim("tair_annotations_topr.tsv", sep="\t", header=TRUE)

# Save in .rda format for compact storage (optional)
# save(arabidopsis, file="arabidopsis.rda", compress='xz')

# Load for use with `topr` (if saved as .rda)
# load("arabidopsis.rda")

# --- Load Association Results ---

# Load LFMM results
path_lfmm = 'lfmm_bio1_4topr_last_gen.csv'
lfmm <- read.csv(path_lfmm)

# Load annotations (likely a formatted GFF or similar - commented out)
# ptah_annotations = '../key_files//TAIR10_GFF3_genes_transposons_formatted4topr.csv'
# annotations <- read.csv(ptah_annotations)

# Load Kendall's tau results
path_kendall = 'kendall_bio1_4topr_last_gen.csv'
kendall <- read.csv(path_kendall)

# Load Binomial Regression results
path_binom = 'binom_bio1_4topr_last_gen.csv'
binom <- read.csv(path_binom)

# Load GEMMA 231 genomes results
path_gemma = 'gemma231_bio1_4topr.csv'
gemma <- read.csv(path_gemma)

# --- Optional: Define Colors or Filter by Significance (commented out examples) ---

# greyscale_colors = ['#666666', '#BBBBBB', '#666666', '#BBBBBB', '#666666', '#BBBBBB']
# Define green tones for significant points (alternating dark and light greens)
# green_colors = ['#2aad2a', '#208420']

# Example filtering for significance threshold
# kendall <- kendall[kendall$P< 1e-3, ]
# lfmm <- lfmm[lfmm$P < 1e-3, ]
# binom <- binom[binom$P < 1e-3, ]
# gemma <- gemma[gemma$P < 1e-3, ]

# --- Define Genomic Region (CYP707A1) ---

# Define the genomic region for CYP707A1 (based on comments/coordinates in the original script)
pos_min <- 10520379 # Note: There are conflicting coordinates in the original comments, using the ones used for filtering.
pos_max <- 10523961 # Note: There are conflicting coordinates in the original comments, using the ones used for filtering.
chromosome = 4

# --- Filter for Specific Genomic Region ---

# Filter association results for the defined region on the specified chromosome
kendall <- kendall[kendall$CHROM == chromosome & kendall$POS >= pos_min & kendall$POS <= pos_max, ]
lfmm <- lfmm[lfmm$CHROM == chromosome & lfmm$POS >= pos_min & lfmm$POS <= pos_max, ]
binom <- binom[binom$CHROM == chromosome & binom$POS >= pos_min & binom$POS <= pos_max, ]
gemma <- gemma[gemma$CHROM == chromosome & gemma$POS >= pos_min & gemma$POS <= pos_max, ]


# --- Define Colors for Plotting ---

# Define hex colors manually for the different association results
kendall_color <- "#1a4320"  # Green from Seaborn palette
lfmm_color <- "#ADD7A1"  # Purple from Seaborn palette (Note: this hex looks green/grey, not purple)
binom_color <- "#45894c"  # Orange from Seaborn palette (Note: this hex looks green/grey, not orange)

# Note: A color for GEMMA is defined in a comment but not used in the regionplot call.
# ADD7A1 lfmm binomial 45894c    kendall 1a4320

# --- Create and Save Region Plot ---

# Set plot dimensions
options(repr.plot.width = 10, repr.plot.height = 25)

# Create the region plot using topr, including Kendall, LFMM, and Binomial results
regionplot(list(kendall, lfmm, binom), region=paste0(chromosome, ":", pos_min, "-", pos_max), # Use variables for region
           build = arabidopsis, 
           sign_thresh=5e-06, # Significance threshold for highlighting points
           color=c(kendall_color, lfmm_color, binom_color), # Colors for each dataset
           legend_labels = c("Kendall Tau", 'LFMM', 'binom'), # Labels for the legend
           gene_color="#666666", # Color for genes
           alpha=0.8, # Transparency of points
           size = 5) # Size of points

# Add a vertical line manually in grey (commented out or not fully implemented)


# Open a PDF device for saving the plot
pdf("regionplot_lfmm_kendall_cyt.pdf",width = 10, height = 25)

# Define colors again (repeated, could be moved to the color definition section)
kendall_color <- "#1a4320"
lfmm_color <- "#ADD7A1"
binom_color <- "#45894c"

# Re-create the region plot for saving to PDF
# Note: GEMMA results were filtered but not included in the plot list in the original script.
regionplot(list(kendall, lfmm, binom), region=paste0(chromosome, ":", pos_min, "-", pos_max), # Use variables for region
           build = arabidopsis, 
           color=c(kendall_color, lfmm_color, binom_color), 
           legend_labels = c("Kendall Tau", 'LFMM', 'binom'), 
           gene_color="#666666", 
           alpha=0.8,
            sign_thresh=5e-06,
           size = 5)


# Add a vertical line manually in grey (commented out or not fully implemented)


# Close the PDF device, saving the plot to the specified file
dev.off()

# --- Optional: Display Ordered Results (commented out) ---

# Display Kendall results ordered by p-value
# kendall[order(kendall$P), ]

# Display LFMM results ordered by p-value
# lfmm[order(lfmm$P), ]


